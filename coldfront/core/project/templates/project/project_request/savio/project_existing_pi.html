{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}


{% block title %}
Savio Project Request - Existing PI
{% endblock %}


{% block head %}
{{ wizard.form.media }}
{% endblock %}


{% block content %}
<script type='text/javascript' src="{% static 'selectize/selectize.min.js' %}"></script>
<link rel='stylesheet' type='text/css' href="{% static 'selectize/selectize.bootstrap3.css' %}"/>

<h1>Savio: Principal Investigator</h1><hr>

<ol class="breadcrumb">
  <li>Allocation Type: {{ allocation_type }}</li>
</ol>

<p>Select an existing user to be a Principal Investigator of the project. You may search for the user in the selection field. If the desired user is not listed, you may skip this step and specify information for a new PI in the next step.</p>

{% if allocation_type == 'FCA' %}
  <p>Note: Each PI may only have one FCA at a time, so any that have pending requests or active allocations are not selectable.</p>
{% endif %}

{% if allocation_type == 'PCA' %}
  <p>Note: Each PI may only have one PCA at a time, so any that have pending requests or active allocations are not selectable.</p>
{% endif %}

<form action="" id="existingPiForm" name="existingPiForm" method="post">
  {% csrf_token %}
  <table>
    {{ wizard.management_form }}
    {% if wizard.form.forms %}
      {{ wizard.form.management_form }}
      {% for form in wizard.form.forms %}
        {{ form|crispy }}
      {% endfor %}
    {% else %}
      {{ wizard.form|crispy }}
    {% endif %}
  </table>
  {% if wizard.steps.prev %}
    <button
        class="btn btn-secondary"
        formnovalidate="formnovalidate"
        name="wizard_goto_step"
        type="submit"
        value="{{ wizard.steps.first }}">
      First Step
    </button>
    <button
        class="btn btn-secondary"
        formnovalidate="formnovalidate"
        name="wizard_goto_step"
        type="submit"
        value="{{ wizard.steps.prev }}">
      Previous Step
    </button>
  {% endif %}
  <input class="btn btn-primary" type="submit" id="next" value="Next Step"/>
</form>
<br>

<p>Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}</p>

<script>
  $('select').selectize({
    create: false,
    sortField: 'text'
  })
</script>

<script>

    $('body').on('click', function(e) {
        var target, href;
        //Identifying target object
        target = $(e.target);
        //console.log('HERE', "|", e.target.tagName,"|", e.target.id,"|");
        //If the target object is a link or is contained in a link we show the confirmation message
        if (e.target.tagName === 'A' && e.target.id !== '') {
            //Default behavior is prevented (the link doesn't work)
            e.preventDefault();

            if (window.confirm("Are you sure you want to leave? You will lose progress on the current form.")) {

                //Identify link target
                if (e.target.tagName === 'A') {
                    href = target.attr('href');
                } else {
                    href = target.parents('a').first().attr('href');
                }

                //Redirect
                window.location.href = href;

            }
        }
    });

</script>

{% endblock %}
